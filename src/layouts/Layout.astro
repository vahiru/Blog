---
// src/layouts/Layout.astro
import BaseHead from "../components/BaseHead.astro";
import NavRail from "../components/NavRail.astro";
import Footer from "../components/Footer.astro";
import SearchWidget from "../components/SearchWidget.astro";
import "../styles/global.css";

interface Props {
    title?: string;
    description?: string;
    image?: string;
    articleDate?: Date;
}

const {
    title = "Vahiru's Blog",
    description = "猫猫的自留地",
    // ⚠️ [修改点 1] 默认图片改为 /images/ 目录下的文件
    // 请确保你的 public/images/ 目录下真有这张图，后缀是 png/jpg/webp 都可以，这里改对就行
    image: _image,
    articleDate,
} = Astro.props;

// 如果没传图片，就用默认的
const image = _image || "/images/default-og.png";

// 1. 获取站点域名
const siteBase = Astro.site ? Astro.site.href : "http://localhost:4321";

// 2. 智能链接拼接函数
const resolveImage = (imgSrc: string) => {
    // 情况 A: 已经是网络链接 (https://...) -> 直接用
    if (imgSrc.startsWith("http")) return imgSrc;

    // 情况 B: 已经是绝对路径 (/images/cover.jpg) -> 拼上域名
    if (imgSrc.startsWith("/")) {
        return new URL(imgSrc.slice(1), siteBase).href;
    }
    // 情况 C: 用户只写了文件名 (cover.jpg) -> 自动补全 /images/ 前缀
    // 这是一个容错优化，假设你的图片都在 images 文件夹
    return new URL(`images/${imgSrc}`, siteBase).href;
};

const canonicalURL = new URL(Astro.url.pathname, siteBase);
const socialImageURL = resolveImage(image); // 使用新函数处理
const siteTitle = "Vahiru's Blog";
const pageTitle = title === siteTitle ? siteTitle : `${title} | ${siteTitle}`;
---

<!doctype html>
<html lang="zh-CN">
    <head>
        <BaseHead title={pageTitle} description={description} image={image} />

        <link
            rel="alternate"
            type="application/rss+xml"
            title="Vahiru's Blog RSS Feed"
            href="/rss.xml"
        />

        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:url" content={canonicalURL} />
        <meta property="og:site_name" content={siteTitle} />
        <meta property="og:locale" content="zh_CN" />
        <meta property="og:image" content={socialImageURL} />

        {
            articleDate ? (
                <>
                    <meta property="og:type" content="article" />
                    <meta
                        property="article:published_time"
                        content={articleDate.toISOString()}
                    />
                </>
            ) : (
                <meta property="og:type" content="website" />
            )
        }

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={pageTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={socialImageURL} />

        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        />

        <script is:inline>
            const theme = (() => {
                if (
                    typeof localStorage !== "undefined" &&
                    localStorage.getItem("theme")
                ) {
                    return localStorage.getItem("theme");
                }
                if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                    return "dark";
                }
                return "light";
            })();
            if (theme === "dark") {
                document.documentElement.classList.add("dark");
            }
        </script>
    </head>

    <body>
        <div id="scrim" class="scrim"></div>

        <header class="mobile-top-bar">
            <button id="menu-btn" class="icon-btn" aria-label="Menu">
                <md-icon>menu</md-icon>
            </button>
            <div class="header-title">{title}</div>
            <button class="icon-btn search-trigger" aria-label="Search">
                <md-icon>search</md-icon>
            </button>
        </header>

        <div class="app-layout">
            <NavRail />
            <main class="main-content">
                <div class="content-inner">
                    <slot />
                </div>
                <Footer />
            </main>
        </div>

        <SearchWidget />

        <script>
            import "@material/web/icon/icon.js";
            import "@material/web/button/elevated-button.js";
            import "@material/web/button/filled-tonal-button.js";
            import "@material/web/ripple/ripple.js";

            const menuBtn = document.getElementById("menu-btn");
            const scrim = document.getElementById("scrim");
            const body = document.body;

            menuBtn?.addEventListener("click", () =>
                body.classList.add("drawer-open"),
            );
            scrim?.addEventListener("click", () =>
                body.classList.remove("drawer-open"),
            );
            document.addEventListener("astro:after-swap", () =>
                body.classList.remove("drawer-open"),
            );

            const searchBtns = document.querySelectorAll(
                'button[aria-label="Search"]',
            );
            searchBtns.forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    e.preventDefault();
                    window.dispatchEvent(new Event("open-search"));
                });
            });
        </script>
    </body>
</html>

<style>
    .app-layout {
        display: contents;
    }
    .main-content {
        background-color: var(--md-sys-color-surface-container);
        transition: background-color 0.3s ease;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    .content-inner {
        flex: 1;
        width: 100%;
        box-sizing: border-box;
    }
    .scrim {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }
    body.drawer-open .scrim {
        opacity: 1;
        pointer-events: auto;
    }
    .icon-btn {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--md-sys-color-on-surface);
        border-radius: 50%;
        background: transparent;
        border: none;
        cursor: pointer;
    }
    .icon-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    @media (min-width: 993px) {
        .mobile-top-bar {
            display: none;
        }
        .main-content {
            border-top-left-radius: 28px;
            border-bottom-left-radius: 28px;
            grid-column: 2 / 3;
            height: 100vh;
            overflow-y: auto;
        }
        .content-inner {
            padding: 2rem 3rem;
        }
    }
    @media (max-width: 992px) {
        .mobile-top-bar {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            z-index: 100;
            background: var(--md-sys-color-surface);
            padding: 0 8px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .header-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }
        .main-content {
            grid-column: 1 / -1;
            border-radius: 0;
            padding-top: 64px;
            height: auto;
            min-height: 100vh;
            overflow-y: visible;
            background-color: var(--md-sys-color-surface);
        }
        .content-inner {
            padding: 1rem;
        }
    }
</style>
