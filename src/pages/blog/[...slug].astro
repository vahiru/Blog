---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import '@material/web/icon/icon.js';
import '@material/web/button/text-button.js';
import '@material/web/button/filled-tonal-button.js';
import '@material/web/divider/divider.js';

interface Props {
    post: CollectionEntry<'blog'>;
}

export async function getStaticPaths() {
    const posts = await getCollection('blog');
    return posts.map(post => ({
        params: { slug: post.slug }, 
        props: { post }, 
    }));
}

const { post } = Astro.props;
const { Content } = await post.render(); 

// === 1. 强力日期修复逻辑 ===
let dateObj;
try {
    // 优先读 date，没有读 pubDate，再没有用当前时间
    // @ts-ignore
    const raw = post.data.date || post.data.pubDate || new Date();
    dateObj = new Date(raw);
} catch(e) { dateObj = new Date(); }

const formattedDate = isNaN(dateObj.getTime()) 
    ? '暂无日期' 
    : dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

// === 2. 动态背景色 (用于无图时的 Header) ===
const themes = [
  'var(--md-sys-color-primary-container)',
  'var(--md-sys-color-secondary-container)',
  'var(--md-sys-color-tertiary-container)',
];
const themeColor = themes[post.data.title.length % themes.length];
const onThemeColor = themeColor.replace('container', 'on-container');
---

<Layout title={post.data.title}>
  <article class="article-container">
    
    <header class="post-header">
        <div class="back-nav">
            <md-text-button href="/">
                <md-icon slot="icon">arrow_back</md-icon>
                返回首页
            </md-text-button>
        </div>

        {post.data.cover ? (
            <div class="cover-wrapper">
                <img src={post.data.cover} alt={post.data.title} class="post-cover" onerror="this.style.display='none'"/>
            </div>
        ) : (
            <div class="title-banner" style={`background-color: ${themeColor}; color: ${onThemeColor.replace('var(', 'var(--md-sys-color-')}`}>
               <md-icon class="banner-icon">article</md-icon>
            </div>
        )}
        
        <div class="header-text">
            <h1 class="post-title">{post.data.title}</h1>
            
            <div class="post-meta">
                <div class="meta-item">
                    <md-icon>calendar_today</md-icon>
                    <span>{formattedDate}</span>
                </div>
                </div>
        </div>
    </header>

    <md-divider></md-divider>

    <section class="post-content">
        <Content />
    </section>

    <md-divider></md-divider>

    <footer class="post-footer">
        <span class="tags-label">Tags:</span>
        <div class="tags-list">
            {post.data.tags?.map(tag => (
                <a href={`/tags/${tag}`} class="tag-chip">
                    #{tag}
                </a>
            ))}
        </div>
    </footer>

  </article>
</Layout>

<style is:global>
  /* === 正文排版样式 (Markdown 内容) === */
  .post-content {
    font-size: 1.125rem; /* 18px，更适合阅读 */
    line-height: 1.8;
    color: var(--md-sys-color-on-surface);
    padding: 2rem 0;
  }

  /* 标题 */
  .post-content h1, .post-content h2, .post-content h3 {
    color: var(--md-sys-color-on-surface);
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    font-weight: 500;
    line-height: 1.3;
  }
  .post-content h2 { font-size: 1.75rem; border-left: 4px solid var(--md-sys-color-primary); padding-left: 16px; }
  .post-content h3 { font-size: 1.4rem; }

  /* 段落 */
  .post-content p { margin-bottom: 1.5rem; }

  /* 列表 */
  .post-content ul, .post-content ol { margin-bottom: 1.5rem; padding-left: 2rem; }
  .post-content li { margin-bottom: 0.5rem; }

  /* 引用 */
  .post-content blockquote {
    background-color: var(--md-sys-color-surface-container-high);
    border-left: 4px solid var(--md-sys-color-tertiary);
    margin: 2rem 0;
    padding: 1.5rem;
    border-radius: 0 16px 16px 0;
    font-style: italic;
  }

  /* 代码块 */
  .post-content pre {
    background-color: #1e1e1e; /* 强制深色背景 */
    color: #e0e0e0;
    padding: 1.5rem;
    border-radius: 16px;
    overflow-x: auto;
    margin: 2rem 0;
    font-family: 'Fira Code', monospace;
    font-size: 0.95rem;
  }
  .post-content code {
    background-color: var(--md-sys-color-surface-variant);
    color: var(--md-sys-color-on-surface-variant);
    padding: 0.2em 0.4em;
    border-radius: 6px;
    font-size: 0.9em;
    font-family: monospace;
  }
  
  /* 图片 */
  .post-content img {
      max-width: 100%;
      border-radius: 16px;
      height: auto;
      margin: 1.5rem 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
</style>

<style>
    /* === 页面容器样式 === */
    .article-container {
        max-width: 840px; /* 限制阅读宽度，太宽累眼睛 */
        margin: 0 auto;
        background-color: var(--md-sys-color-surface); /* 纸张背景 */
        padding: 0; /* 移动端贴边，桌面端有圆角 */
        min-height: 100%;
    }

    /* 桌面端优化：卡片化 */
    @media (min-width: 768px) {
        .article-container {
            margin: 2rem auto;
            padding: 3rem 4rem;
            border-radius: 28px; /* 变成一张大卡片 */
            /* 可选：给文章卡片加一点微弱的阴影 */
            /* box-shadow: 0 1px 3px rgba(0,0,0,0.05); */
        }
    }

    /* === Header === */
    .post-header { margin-bottom: 2rem; }
    
    .back-nav { margin-bottom: 1.5rem; margin-left: -12px; } /* 负边距对齐文字 */

    .cover-wrapper {
        width: 100%; height: 300px;
        border-radius: 24px; overflow: hidden;
        margin-bottom: 2rem;
        background-color: var(--md-sys-color-surface-variant);
    }
    .post-cover { width: 100%; height: 100%; object-fit: cover; }

    /* 无图时的标题横幅 */
    .title-banner {
        width: 100%; height: 200px;
        border-radius: 24px;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 2rem;
    }
    .banner-icon { font-size: 64px; opacity: 0.5; }

    .post-title {
        font-size: 2.5rem;
        line-height: 1.2;
        font-weight: 600; /* 加粗 */
        color: var(--md-sys-color-on-surface);
        margin: 0 0 1rem 0;
    }

    .post-meta {
        display: flex; gap: 16px;
        color: var(--md-sys-color-on-surface-variant);
        font-size: 0.95rem;
    }
    .meta-item { display: flex; align-items: center; gap: 6px; }

    /* === Footer === */
    .post-footer {
        padding-top: 2rem;
        display: flex; flex-wrap: wrap; align-items: center; gap: 12px;
    }
    .tags-label { font-weight: 500; color: var(--md-sys-color-on-surface); }
    
    .tag-chip {
        display: inline-flex; align-items: center;
        height: 32px; padding: 0 16px;
        border-radius: 8px; /* Chip 样式 */
        background-color: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
        text-decoration: none;
        font-size: 0.9rem; font-weight: 500;
        transition: opacity 0.2s;
    }
    .tag-chip:hover { opacity: 0.8; }
</style>